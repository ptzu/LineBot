# æœƒå“¡ç³»çµ±ä½¿ç”¨èªªæ˜

## æ¦‚è¿°

æœ¬å°ˆæ¡ˆå·²æ•´åˆå®Œæ•´çš„æœƒå“¡ç³»çµ±ï¼ŒåŒ…å«ï¼š
- âœ… é»æ•¸ç®¡ç†ï¼ˆæŸ¥è©¢ã€å¢åŠ ã€æ‰£é™¤ï¼‰
- âœ… äº¤æ˜“è¨˜éŒ„ï¼ˆå®Œæ•´çš„é»æ•¸ç•°å‹•æ­·å²ï¼‰
- âœ… æœƒå“¡ç‹€æ…‹ï¼ˆæ­£å¸¸ã€VIPã€åœç”¨ã€é»‘åå–®ï¼‰
- âœ… PostgreSQL è³‡æ–™åº«ï¼ˆæ”¯æ´å¤§é‡ä½¿ç”¨è€…ï¼‰
- âœ… React Web å…±ç”¨è³‡æ–™åº«

## åŠŸèƒ½ç‰¹è‰²

### 1. è‡ªå‹•æœƒå“¡å»ºç«‹
- ç”¨æˆ¶é¦–æ¬¡ä½¿ç”¨æ™‚è‡ªå‹•å»ºç«‹æœƒå“¡è³‡æ–™
- åˆå§‹é»æ•¸ï¼š0 é»
- åˆå§‹ç‹€æ…‹ï¼šnormalï¼ˆæ­£å¸¸ï¼‰

### 2. é»æ•¸ç³»çµ±
- **å½©è‰²åŒ–åœ–ç‰‡**ï¼šæ¶ˆè€— 10 é»ï¼ˆå¯é€é `COLORIZE_COST` ç’°å¢ƒè®Šæ•¸èª¿æ•´ï¼‰
- **åœ–ç‰‡ç·¨è¼¯**ï¼šæ¶ˆè€— 5 é»ï¼ˆå¯é€é `EDIT_COST` ç’°å¢ƒè®Šæ•¸èª¿æ•´ï¼‰
- é»æ•¸ä¸è¶³æ™‚æœƒè‡ªå‹•æç¤ºç”¨æˆ¶

### 3. LINE Bot æŒ‡ä»¤

#### æŸ¥è©¢é»æ•¸
ç”¨æˆ¶è¼¸å…¥ï¼š`é»æ•¸`

å›è¦†å…§å®¹ï¼š
```
ğŸ’° é»æ•¸æŸ¥è©¢

ğŸ‘¤ ç‹å°æ˜
ğŸ’ å‰©é¤˜é»æ•¸ï¼š100 é»
âœ… æœƒå“¡ç‹€æ…‹ï¼šæ­£å¸¸

è¼¸å…¥ã€Œæ­·å²ã€æŸ¥çœ‹äº¤æ˜“è¨˜éŒ„
è¼¸å…¥ã€Œæœƒå“¡è³‡è¨Šã€æŸ¥çœ‹å®Œæ•´è³‡æ–™
```

#### æŸ¥çœ‹äº¤æ˜“è¨˜éŒ„
ç”¨æˆ¶è¼¸å…¥ï¼š`æ­·å²`

å›è¦†å…§å®¹ï¼š
```
ğŸ“Š äº¤æ˜“è¨˜éŒ„ï¼ˆæœ€è¿‘ 10 ç­†ï¼‰

12/15 14:30 ğŸ’³ æ¶ˆè²»
-10 é» â†’ é¤˜é¡ 90 é»
èªªæ˜ï¼šå½©è‰²åŒ–åœ–ç‰‡

12/14 10:20 ğŸ ç²å¾—
+50 é» â†’ é¤˜é¡ 100 é»
èªªæ˜ï¼šæ¯æ—¥ç°½åˆ°

ğŸ’ ç›®å‰é»æ•¸ï¼š90 é»
```

#### æŸ¥çœ‹æœƒå“¡è³‡è¨Š
ç”¨æˆ¶è¼¸å…¥ï¼š`æœƒå“¡è³‡è¨Š` æˆ– `æœƒå“¡`

å›è¦†å…§å®¹ï¼š
```
ğŸ‘¤ æœƒå“¡è³‡è¨Š

ğŸ“ å§“åï¼šç‹å°æ˜
ğŸ†” IDï¼šU1234567...
ğŸ’ å‰©é¤˜é»æ•¸ï¼š90 é»
ğŸ“Š æœƒå“¡ç‹€æ…‹ï¼šæ­£å¸¸
ğŸ“… è¨»å†Šæ—¥æœŸï¼š2024/12/01 10:30

è¼¸å…¥ã€Œé»æ•¸ã€æŸ¥çœ‹é»æ•¸
è¼¸å…¥ã€Œæ­·å²ã€æŸ¥çœ‹äº¤æ˜“è¨˜éŒ„
```

## æ¶æ§‹èªªæ˜

### è³‡æ–™åº«å±¤ (`models/`)

```
models/
â”œâ”€â”€ database.py           # è³‡æ–™åº«é€£ç·šç®¡ç†
â”œâ”€â”€ member.py            # æœƒå“¡æ¨¡å‹
â””â”€â”€ point_transaction.py # äº¤æ˜“è¨˜éŒ„æ¨¡å‹
```

**æœƒå“¡è¡¨ (members)**
- `user_id`: LINE user ID (ä¸»éµ)
- `display_name`: é¡¯ç¤ºåç¨±
- `picture_url`: é ­åƒ URL
- `email`: ä¿¡ç®±ï¼ˆå¯é¸ï¼‰
- `points`: å‰©é¤˜é»æ•¸
- `status`: æœƒå“¡ç‹€æ…‹ (normal/vip/suspended/banned)
- `created_at`: å»ºç«‹æ™‚é–“
- `updated_at`: æ›´æ–°æ™‚é–“

**äº¤æ˜“è¨˜éŒ„è¡¨ (point_transactions)**
- `id`: äº¤æ˜“ ID (ä¸»éµ)
- `user_id`: æœƒå“¡ ID (å¤–éµ)
- `transaction_type`: äº¤æ˜“é¡å‹
  - `earn` - ç²å¾—é»æ•¸
  - `spend` - æ¶ˆè²»é»æ•¸
  - `admin_add` - ç®¡ç†å“¡å¢åŠ 
  - `admin_deduct` - ç®¡ç†å“¡æ‰£é™¤
  - `expire` - é»æ•¸éæœŸ
- `points`: é»æ•¸è®Šå‹•
- `balance_after`: äº¤æ˜“å¾Œé¤˜é¡
- `description`: äº¤æ˜“èªªæ˜
- `created_at`: äº¤æ˜“æ™‚é–“

### æœå‹™å±¤ (`services/`)

```
services/
â””â”€â”€ member_service.py    # æœƒå“¡æ¥­å‹™é‚è¼¯
```

**MemberService é¡åˆ¥æä¾›ï¼š**
- `get_or_create_member()` - å–å¾—æˆ–å»ºç«‹æœƒå“¡
- `get_member_info()` - æŸ¥è©¢æœƒå“¡è³‡è¨Š
- `get_member_points()` - æŸ¥è©¢é»æ•¸
- `add_points()` - å¢åŠ é»æ•¸
- `deduct_points()` - æ‰£é™¤é»æ•¸ï¼ˆæª¢æŸ¥é¤˜é¡ï¼‰
- `get_point_history()` - æŸ¥è©¢äº¤æ˜“è¨˜éŒ„
- `update_member_status()` - æ›´æ–°æœƒå“¡ç‹€æ…‹

### åŠŸèƒ½å±¤ (`features/`)

```
features/
â”œâ”€â”€ member_feature.py     # æœƒå“¡æŸ¥è©¢åŠŸèƒ½
â”œâ”€â”€ colorize_feature.py   # å½©è‰²åŒ–åŠŸèƒ½ï¼ˆå·²æ•´åˆé»æ•¸ï¼‰
â””â”€â”€ edit_feature.py       # ç·¨è¼¯åŠŸèƒ½ï¼ˆå·²æ•´åˆé»æ•¸ï¼‰
```

## å®‰è£æ­¥é©Ÿ

### 1. å®‰è£ä¾è³´å¥—ä»¶

```bash
pip install -r requirements.txt
```

æ–°å¢çš„å¥—ä»¶ï¼š
- `SQLAlchemy==2.0.23` - ORM æ¡†æ¶
- `psycopg2-binary==2.9.9` - PostgreSQL é©…å‹•

### 2. ç”³è«‹ Supabase è³‡æ–™åº«

è©³ç´°æ­¥é©Ÿè«‹åƒè€ƒï¼š[SUPABASE_SETUP.md](./SUPABASE_SETUP.md)

ç°¡è¦æ­¥é©Ÿï¼š
1. å‰å¾€ https://supabase.com/ è¨»å†Š
2. å»ºç«‹æ–°å°ˆæ¡ˆï¼ˆé¸æ“‡ Tokyo æˆ– Singapore å€åŸŸï¼‰
3. å–å¾— DATABASE_URL
4. è¨­å®šåˆ° `.env` æª”æ¡ˆ

### 3. è¨­å®šç’°å¢ƒè®Šæ•¸

ç·¨è¼¯ `.env` æª”æ¡ˆï¼š

```env
# LINE Bot è¨­å®š
CHANNEL_ACCESS_TOKEN=your_line_channel_access_token_here
CHANNEL_SECRET=your_line_channel_secret_here

# Replicate API è¨­å®š
REPLICATE_API_TOKEN=your_replicate_api_token_here

# Database è³‡æ–™åº«è¨­å®š
DATABASE_URL=postgresql://postgres:your-password@db.xxx.supabase.co:5432/postgres

# Feature Point Costs
COLORIZE_COST=10
EDIT_COST=5
```

### 4. åˆå§‹åŒ–è³‡æ–™åº«

```bash
python scripts/init_db.py
```

æˆåŠŸè¨Šæ¯ï¼š
```
ğŸ‰ è³‡æ–™åº«åˆå§‹åŒ–å®Œæˆï¼
```

### 5. å•Ÿå‹• LINE Bot

```bash
python app.py
```

æª¢æŸ¥å•Ÿå‹•è¨Šæ¯ï¼š
```
âœ… è³‡æ–™åº«é€£ç·šåˆå§‹åŒ–å®Œæˆ
âœ… æœƒå“¡æœå‹™åˆå§‹åŒ–å®Œæˆ
âœ… æœƒå“¡åŠŸèƒ½å·²å•Ÿç”¨
```

## ä½¿ç”¨ç¯„ä¾‹

### å ´æ™¯ 1ï¼šç”¨æˆ¶é¦–æ¬¡ä½¿ç”¨

1. ç”¨æˆ¶è¼¸å…¥ï¼š`é»æ•¸`
2. ç³»çµ±è‡ªå‹•å»ºç«‹æœƒå“¡ï¼ˆåˆå§‹é»æ•¸ 0ï¼‰
3. å›è¦†ç›®å‰é»æ•¸

### å ´æ™¯ 2ï¼šä½¿ç”¨å½©è‰²åŒ–åŠŸèƒ½

1. ç”¨æˆ¶è¼¸å…¥ï¼š`åœ–ç‰‡å½©è‰²åŒ–`
2. ç³»çµ±æª¢æŸ¥é»æ•¸ï¼ˆéœ€è¦ 10 é»ï¼‰
3. å¦‚æœé»æ•¸ä¸è¶³ï¼š
   ```
   âŒ é»æ•¸ä¸è¶³ï¼
   
   ğŸ’ ç›®å‰é»æ•¸ï¼š5 é»
   ğŸ’° éœ€è¦é»æ•¸ï¼š10 é»
   
   è«‹è¼¸å…¥ã€Œé»æ•¸ã€æŸ¥çœ‹è©³ç´°è³‡è¨Š
   ```
4. å¦‚æœé»æ•¸è¶³å¤ ï¼š
   - ç”¨æˆ¶ä¸Šå‚³åœ–ç‰‡
   - ç³»çµ±è™•ç†åœ–ç‰‡
   - è‡ªå‹•æ‰£é™¤ 10 é»
   - è¨˜éŒ„äº¤æ˜“ï¼š`å½©è‰²åŒ–åœ–ç‰‡`

### å ´æ™¯ 3ï¼šç®¡ç†å“¡å¢åŠ é»æ•¸

åœ¨ Python ä¸­ï¼š

```python
from services.member_service import MemberService

member_service = MemberService()

# å¢åŠ  100 é»çµ¦ç”¨æˆ¶
member_service.add_points(
    user_id="U1234567890abcdef",
    points=100,
    transaction_type="admin_add",
    description="æ¯æ—¥ç°½åˆ°çå‹µ"
)
```

æˆ–åœ¨ Supabase SQL Editorï¼š

```sql
-- æŸ¥è©¢ç”¨æˆ¶ç›®å‰é»æ•¸
SELECT user_id, display_name, points FROM members 
WHERE user_id = 'U1234567890abcdef';

-- ç›´æ¥å¢åŠ é»æ•¸ï¼ˆä¸æ¨è–¦ï¼Œæ‡‰ä½¿ç”¨ APIï¼‰
UPDATE members SET points = points + 100 
WHERE user_id = 'U1234567890abcdef';
```

## é€²éšåŠŸèƒ½

### æœƒå“¡ç‹€æ…‹ç®¡ç†

```python
from services.member_service import MemberService

member_service = MemberService()

# è¨­ç‚º VIP
member_service.update_member_status("U1234567890abcdef", "vip")

# åœç”¨æœƒå“¡
member_service.update_member_status("U1234567890abcdef", "suspended")

# é»‘åå–®
member_service.update_member_status("U1234567890abcdef", "banned")

# æ¢å¾©æ­£å¸¸
member_service.update_member_status("U1234567890abcdef", "normal")
```

### æ‰¹æ¬¡æŸ¥è©¢

```python
from models.database import get_session
from models.member import Member

# æŸ¥è©¢æ‰€æœ‰ VIP æœƒå“¡
with get_session() as session:
    vip_members = session.query(Member).filter_by(status='vip').all()
    for member in vip_members:
        print(f"{member.display_name}: {member.points} é»")
```

### é»æ•¸æ’è¡Œæ¦œ

```python
from models.database import get_session
from models.member import Member

# æŸ¥è©¢é»æ•¸å‰ 10 å
with get_session() as session:
    top_members = session.query(Member)\
        .order_by(Member.points.desc())\
        .limit(10)\
        .all()
    
    for i, member in enumerate(top_members, 1):
        print(f"{i}. {member.display_name}: {member.points} é»")
```

## React Web æ•´åˆ

React Web å°ˆæ¡ˆå¯ä»¥å…±ç”¨åŒä¸€å€‹è³‡æ–™åº«ï¼š

1. ä½¿ç”¨ç›¸åŒçš„ `DATABASE_URL`
2. é€é REST API å­˜å–è³‡æ–™
3. ä½¿ç”¨ LINE Login é©—è­‰èº«ä»½ï¼ˆ`user_id` è‡ªå‹•é—œè¯ï¼‰

è©³ç´° API å¯¦ä½œè«‹åƒè€ƒè¨ˆç•«æ–‡ä»¶ï¼ˆæœªä¾†å¯¦ä½œï¼‰ã€‚

## å¸¸è¦‹å•é¡Œ

### Q1: å¦‚ä½•èª¿æ•´åŠŸèƒ½é»æ•¸è²»ç”¨ï¼Ÿ

A: ä¿®æ”¹ `.env` æª”æ¡ˆï¼š
```env
COLORIZE_COST=20  # æ”¹ç‚º 20 é»
EDIT_COST=10      # æ”¹ç‚º 10 é»
```

### Q2: å¦‚ä½•æ‰‹å‹•å¢åŠ æœƒå“¡é»æ•¸ï¼Ÿ

A: ä¸‰ç¨®æ–¹å¼ï¼š
1. ä½¿ç”¨ Python è…³æœ¬ï¼ˆæ¨è–¦ï¼‰
2. åœ¨ Supabase SQL Editor åŸ·è¡Œ SQL
3. é€é Supabase Table Editor ç›´æ¥ç·¨è¼¯

### Q3: è³‡æ–™æœƒéºå¤±å—ï¼Ÿ

A: ä¸æœƒã€‚è³‡æ–™å„²å­˜åœ¨ PostgreSQL è³‡æ–™åº«ä¸­ï¼š
- Supabase æœƒè‡ªå‹•å‚™ä»½
- Server é‡å•Ÿå¾Œè³‡æ–™ä»ç„¶å­˜åœ¨
- å»ºè­°å®šæœŸåŒ¯å‡ºé‡è¦è³‡æ–™

### Q4: å¦‚ä½•æŸ¥çœ‹æ‰€æœ‰æœƒå“¡è³‡æ–™ï¼Ÿ

A: 
1. å‰å¾€ Supabase å°ˆæ¡ˆ
2. é»æ“Š Table Editor
3. é¸æ“‡ `members` è¡¨
4. å³å¯çœ‹åˆ°æ‰€æœ‰æœƒå“¡è³‡æ–™

### Q5: èƒ½å¦ä¸ä½¿ç”¨è³‡æ–™åº«ï¼Ÿ

A: å¯ä»¥ï¼Œä½†æœƒå¤±å»ä»¥ä¸‹åŠŸèƒ½ï¼š
- é»æ•¸ç³»çµ±
- äº¤æ˜“è¨˜éŒ„
- æœƒå“¡ç‹€æ…‹ç®¡ç†
- è³‡æ–™æŒä¹…åŒ–

å¦‚æœä¸è¨­å®š `DATABASE_URL`ï¼ŒLINE Bot ä»å¯æ­£å¸¸é‹ä½œï¼Œåªæ˜¯æ²’æœ‰æœƒå“¡åŠŸèƒ½ã€‚

## æ•ˆèƒ½æ³¨æ„äº‹é …

### æŸ¥è©¢ç­–ç•¥

âœ… **åªåœ¨éœ€è¦æ™‚æŸ¥è©¢**
- ç”¨æˆ¶è¼¸å…¥ã€Œé»æ•¸ã€æ™‚
- ä½¿ç”¨åŠŸèƒ½å‰æª¢æŸ¥é¤˜é¡
- ä¸€èˆ¬è¨Šæ¯ä¸æŸ¥è©¢

âŒ **ä¸è¦æ¯å€‹è«‹æ±‚éƒ½æŸ¥**
- æœƒå¢åŠ è³‡æ–™åº«è² è¼‰
- å½±éŸ¿å›æ‡‰é€Ÿåº¦

### è³‡æ–™åº«é€£ç·šæ± 

å·²è¨­å®šé€£ç·šæ± åƒæ•¸ï¼š
- `pool_size=5` - æœ€å¤š 5 å€‹é€£ç·š
- `max_overflow=10` - æœ€å¤šé¡å¤– 10 å€‹è‡¨æ™‚é€£ç·š
- `pool_pre_ping=True` - è‡ªå‹•æª¢æ¸¬é€£ç·šæœ‰æ•ˆæ€§

### äº¤æ˜“å®‰å…¨

æ‰€æœ‰é»æ•¸æ“ä½œéƒ½ä½¿ç”¨ database transactionï¼š
- ç¢ºä¿åŸå­æ€§ï¼ˆè¦éº¼å…¨éƒ¨æˆåŠŸï¼Œè¦éº¼å…¨éƒ¨å¤±æ•—ï¼‰
- é¿å…ä¸¦ç™¼å•é¡Œï¼ˆä½¿ç”¨ `with_for_update()` é–å®šï¼‰
- ä¿è­‰é¤˜é¡ä¸€è‡´æ€§

## æœªä¾†æ“´å……å»ºè­°

1. **é»æ•¸éæœŸæ©Ÿåˆ¶**
   - è¨­å®šé»æ•¸æœ‰æ•ˆæœŸ
   - è‡ªå‹•æ¸…é™¤éæœŸé»æ•¸

2. **é»æ•¸å…Œæ›åŠŸèƒ½**
   - é»æ•¸å…Œæ›å„ªæƒ åˆ¸
   - é»æ•¸å…Œæ›å¯¦é«”å•†å“

3. **æ¯æ—¥ç°½åˆ°**
   - é€£çºŒç°½åˆ°çå‹µ
   - ç°½åˆ°è¨˜éŒ„

4. **æ¨è–¦çå‹µ**
   - æ¨è–¦å¥½å‹ç²å¾—é»æ•¸
   - è¿½è¹¤æ¨è–¦é—œä¿‚

5. **æœƒå“¡ç­‰ç´š**
   - æ ¹æ“šç´¯è¨ˆæ¶ˆè²»è‡ªå‹•å‡ç´š
   - ä¸åŒç­‰ç´šä¸åŒå„ªæƒ 

## æŠ€è¡“æ”¯æ´

å¦‚æœ‰å•é¡Œï¼Œè«‹æª¢æŸ¥ï¼š
1. ç’°å¢ƒè®Šæ•¸æ˜¯å¦æ­£ç¢ºè¨­å®š
2. è³‡æ–™åº«æ˜¯å¦æ­£å¸¸é‹ä½œ
3. ç¨‹å¼å•Ÿå‹•æ™‚çš„ log è¨Šæ¯
4. Supabase å°ˆæ¡ˆçš„ Logs

---

æœƒå“¡ç³»çµ±è¨­å®šå®Œæˆå¾Œï¼Œæ‚¨çš„ LINE Bot å°±å…·å‚™å®Œæ•´çš„é»æ•¸ç®¡ç†åŠŸèƒ½äº†ï¼ğŸ‰

